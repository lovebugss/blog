<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>使用Postman 进行新老接口数据diff</title><meta name="description" content="一个小白的艰难成长之路"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="

背景: 公司最近需要将原有php服务使用java进行重构. 为了保证重构后的接口正确性, 需要对数据进行对比, 保证数据的完全一致. 所以就需要对数据进行对比.大致思路是: 再发送请求之前, 通过修改host, 先获取旧得数据, 然后放入环境变量. 然后再使用jsondiffpatch工具进行数据对比.


在Postman中引入jsondiffpatchPostman 支持js语法, 本身就有封装node环境. 所以可以引入第三方js库.
具体方法如下:

在请求之前, 获取jsondiffpatch代码, 然后放入环境变量.
 
 // 当运行多个测试用例时, 会导致文件拉去多次. 
 // 这里做个判断, 先检查环境变量中有没有, 若有就不重新拉取
 var code = pm.environme.."><meta name="generator" content="Hexo 4.2.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">任大忽悠的个人博客</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">使用Postman 进行新老接口数据diff</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#在Postman中引入jsondiffpatch"><span class="toc-text">在Postman中引入jsondiffpatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境变量"><span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完整代码"><span class="toc-text">完整代码</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/postman"><i class="tag post-item-tag">postman</i></a><a href="/tags/diff"><i class="tag post-item-tag">diff</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">使用Postman 进行新老接口数据diff</h1><time class="has-text-grey" datetime="2021-09-04T16:11:47.638Z">2021-09-04</time><article class="mt-2 post-content"><p><img src="https://i.loli.net/2021/09/05/cyHrofv5zgKTaQx.png" alt="Blog_Postman2_1200x600"></p>
<blockquote>
<p>背景: 公司最近需要将原有php服务使用java进行重构. 为了保证重构后的接口正确性, 需要对数据进行对比, 保证数据的完全一致. 所以就需要对数据进行对比.<br>大致思路是: 再发送请求之前, 通过修改host, 先获取旧得数据, 然后放入环境变量. 然后再使用jsondiffpatch工具进行数据对比.</p>
</blockquote>
<a id="more"></a>
<h2 id="在Postman中引入jsondiffpatch"><a href="#在Postman中引入jsondiffpatch" class="headerlink" title="在Postman中引入jsondiffpatch"></a>在Postman中引入jsondiffpatch</h2><p>Postman 支持js语法, 本身就有封装node环境. 所以可以引入第三方js库.</p>
<p>具体方法如下:</p>
<ol>
<li><p>在请求之前, 获取jsondiffpatch代码, 然后放入环境变量.</p>
<p> <img src="https://i.loli.net/2021/09/05/tyNPwzJKVi7S4Hl.png" alt="Untitled"></p>
<pre><code class="jsx"> // 当运行多个测试用例时, 会导致文件拉去多次. 
 // 这里做个判断, 先检查环境变量中有没有, 若有就不重新拉取
 var code = pm.environment.get("jsondiffpatch_code")
 if(!code){
     // 引入jsondiffpatch.js
     pm.sendRequest("https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js", (err, res)=&gt;{
         if(err){
             console.log("error: " + err);
         }else{
             pm.environment.set("jsondiffpatch_code", res.text());
         }
     })
 }</code></pre>
</li>
<li><p>执行jsondiffpatch代码<br><img src="https://i.loli.net/2021/09/05/HanOXY7QvRst94F.png" alt="Untitled 1"></p>
</li>
</ol>
<pre><code>```jsx
// 引入
let code = pm.environment.get("jsondiffpatch_code");
if(code){
   (new Function(code))() 
}
```

引入之后, 就可以使用jsondiffpatch了.</code></pre><h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><pre><code class="jsx">*host: 新服务host
*old_host: 老服务host
jsondiffpatch_code: 用来存储jsondiffpatch代码.
old_data: 存放就接口数据.</code></pre>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>Pre-request-script</p>
<pre><code class="jsx">// 当运行多个测试用例时, 会导致文件拉去多次. 
// 这里做个判断, 先检查环境变量中有没有, 若有就不重新拉去
var code = pm.environment.get("jsondiffpatch_code")
if(!code){
    // 引入jsondiffpatch.js
    pm.sendRequest("https://cdn.jsdelivr.net/npm/jsondiffpatch/dist/jsondiffpatch.umd.min.js", (err, res)=&gt;{
        // (new Function(res.text()))()
        pm.environment.set("jsondiffpatch_code", res.text());

    })
}

console.log("当前url: " + pm.request.url)
// 1. 拉去旧数据, 然后进行缓存.
// 将原来的host 缓存
let host = pm.environment.get("host");
// 获取host, 为旧服务器
let oldHost = pm.environment.get("old_host");
let url = pm.request.url;
let oldUrl = url.toString().replace("{{host}}", oldHost)
let method = pm.request.method;

// 发送请求
let requestParam = {
    url: oldUrl,
    method: pm.request.method,
    header: {...pm.request.headers},
    body: {...pm.request.body}
}

pm.sendRequest(requestParam, (error, response) =&gt; {
  if(error){
    console.log(`request url: [${oldUrl}], error: ${error}`)
  }else{
      // 放入环境变量
     pm.environment.set("old_data", response.json()) 
  }
});</code></pre>
<p>Test:</p>
<pre><code class="jsx">// 引入
(new Function(pm.environment.get("jsondiffpatch_code")))()

// 2. 对比结果集是否一致
// 旧数据
let oldData = pm.environment.get("old_data")

// 如果没有拉取到旧数据, 就不进行对比. 不影响后面的逻辑
if(oldData){
    // 新数据
    let data = pm.response.json();
    // 数据对比
    var delta = jsondiffpatch.diff(oldData, data);
    pm.test("data diff", ()=&gt;{
    if(delta){
        console.log(`数据不一致, 差异数据: ${JSON.stringify(delta)}`)
        pm.expect("数据不一致").throw();
    }
    })
}
// 删除旧数据
pm.environment.unset("old_data")</code></pre>
<p>注意: 只需要在最外层引入即可.<br><img src="https://i.loli.net/2021/09/05/W3dCbwNLnuBIPmf.png" alt="Untitled 2"></p>
<p>参考:</p>
<p><a href="https://github.com/benjamine/jsondiffpatch" target="_blank" rel="noopener">https://github.com/benjamine/jsondiffpatch</a></p>
<p><a href="https://learning.postman.com/docs/writing-scripts/script-references/postman-sandbox-api-reference/" target="_blank" rel="noopener">https://learning.postman.com/docs/writing-scripts/script-references/postman-sandbox-api-reference/</a></p>
<p><a href="https://community.postman.com/t/adding-external-libraries-to-postman/1971/20" target="_blank" rel="noopener">https://community.postman.com/t/adding-external-libraries-to-postman/1971/20</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2021/04/10/%E5%9C%A8MAC%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E4%BD%A0%E7%9A%84Lmabda%20%E5%87%BD%E6%95%B0%EF%BC%88nodejs%E7%89%88%EF%BC%89/" title="在MAC环境下本地调试你的Lmabda 函数（nodejs版）"><span class="has-text-weight-semibold">下一页: 在MAC环境下本地调试你的Lmabda 函数（nodejs版）</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/lovebugss"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> 任大忽悠 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" href="//github.com/haojen" target="_blank" rel="noopener">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" href="https://github.com/haojen/hexo-theme-Claudia" target="_blank" rel="noopener" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>